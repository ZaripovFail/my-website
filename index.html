<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MoodFlow Pro</title>

    <!-- PWA Manifest (GitHub Pages compatible) -->
    <link rel="manifest" href="./manifest.json">

    <meta name="theme-color" content="#4a90e2">

    <style>
        body { font-family: Arial, sans-serif; margin:0; background:#f3f3f3; }
        header { background:#4a90e2; color:#fff; padding:14px; font-size:22px; text-align:center; }
        nav { background:white; padding:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
        nav button { border:none; background:#4a90e2; color:white; padding:8px 14px; border-radius:6px; cursor:pointer; }

        section { padding:20px; display:none; }
        section.active { display:block; }

        .mood-btn {
            padding:12px; margin:4px;
            border-radius:10px; border:2px solid #ccc;
            display:inline-block; cursor:pointer;
        }
        .mood-btn.selected { background:#4a90e2; color:white; border-color:#4a90e2; }

        .history-item {
            background:white; padding:10px; margin-bottom:10px;
            border-radius:8px; border-left:5px solid #4a90e2;
        }

        .chart-box { background:white; padding:20px; border-radius:10px; margin-top:20px; }

        .lang-select { padding:8px; width:170px; margin-top:12px; }

    </style>
</head>
<body>

<header>MoodFlow Pro</header>

<nav>
    <button onclick="openPage('new')">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
    <button onclick="openPage('calendar')">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    <button onclick="openPage('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
    <button onclick="openPage('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button onclick="openPage('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</nav>

<!-- New Entry -->
<section id="new" class="active">
    <h2 data-i18n="new_entry">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>

    <h3 data-i18n="mood">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</h3>
    <div id="moodButtons"></div>

    <h3 data-i18n="factors">–§–∞–∫—Ç–æ—Ä—ã</h3>
    <div id="factorList"></div>

    <h3 data-i18n="notes">–ó–∞–º–µ—Ç–∫–∏</h3>
    <textarea id="notes" style="width:100%; height:80px;"></textarea>

    <button onclick="saveEntry()" style="margin-top:10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</section>

<!-- Calendar -->
<section id="calendar">
    <h2 data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
    <div id="calendarRoot"></div>
</section>

<!-- History -->
<section id="history">
    <h2 data-i18n="history">–ò—Å—Ç–æ—Ä–∏—è</h2>
    <div id="historyList"></div>
</section>

<!-- Analytics -->
<section id="analytics">
    <h2 data-i18n="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

    <p id="aiInsights" style="font-weight:bold;"></p>

    <div class="chart-box"><canvas id="moodChart"></canvas></div>
    <div class="chart-box"><canvas id="factorChart"></canvas></div>
</section>

<!-- Settings -->
<section id="settings">
    <h2 data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

    <h3>–≠–∫—Å–ø–æ—Ä—Ç</h3>
    <button onclick="exportCSV()">üìÑ CSV</button>
    <button onclick="exportXLSX()">üìò XLSX</button>

    <h3>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h3>
    <select id="lang" class="lang-select" onchange="changeLang()">
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="tt">–¢–∞—Ç–∞—Ä—á–∞</option>
        <option value="en">English</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="fr">Fran√ßais</option>
    </select>

    <h3>–£—Å—Ç–∞–Ω–æ–≤–∫–∞</h3>
    <p>–î–æ–±–∞–≤—å—Ç–µ —Å–∞–π—Ç –Ω–∞ —ç–∫—Ä–∞–Ω —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω.</p>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* -----------------------------
   DATABASE
------------------------------*/
let DB = JSON.parse(localStorage.getItem("moodflow") || "[]");
let currentMood = null;

/* -----------------------------
   MULTI-LANGUAGE
------------------------------*/
const translations = {
    ru:{new_entry:"–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å", mood:"–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", factors:"–§–∞–∫—Ç–æ—Ä—ã", notes:"–ó–∞–º–µ—Ç–∫–∏", calendar:"–ö–∞–ª–µ–Ω–¥–∞—Ä—å", history:"–ò—Å—Ç–æ—Ä–∏—è", analytics:"–ê–Ω–∞–ª–∏—Ç–∏–∫–∞", settings:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏"},
    tt:{new_entry:"–Ø“£–∞ —è–∑–º–∞", mood:"–ö–∞–π—Ñ", factors:"–§–∞–∫—Ç–æ—Ä–ª–∞—Ä", notes:"–ò—Å–∫”ô—Ä–º”ô–ª”ô—Ä", calendar:"–ö–∞–ª–µ–Ω–¥–∞—Ä—å", history:"–¢–∞—Ä–∏—Ö", analytics:"–ê–Ω–∞–ª–∏—Ç–∏–∫–∞", settings:"–ö”©–π–ª”ô“Ø–ª”ô—Ä"},
    en:{new_entry:"New Entry", mood:"Mood", factors:"Factors", notes:"Notes", calendar:"Calendar", history:"History", analytics:"Analytics", settings:"Settings"},
    ar:{new_entry:"ÿ•ÿØÿÆÿßŸÑ ÿ¨ÿØŸäÿØ", mood:"ÿßŸÑŸÖÿ≤ÿßÿ¨", factors:"ÿßŸÑÿπŸàÿßŸÖŸÑ", notes:"ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™", calendar:"ÿßŸÑÿ™ŸÇŸàŸäŸÖ", history:"ÿßŸÑÿ≥ÿ¨ŸÑ", analytics:"ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™", settings:"ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™"},
    fr:{new_entry:"Nouvelle entr√©e", mood:"Humeur", factors:"Facteurs", notes:"Notes", calendar:"Calendrier", history:"Historique", analytics:"Analytique", settings:"Param√®tres"},
};

function applyLang(){
    let lang = localStorage.getItem("lang") || "ru";
    document.getElementById("lang").value = lang;
    document.querySelectorAll("[data-i18n]").forEach(e=>{
        e.textContent = translations[lang][e.dataset.i18n];
    });
}
applyLang();

function changeLang(){
    localStorage.setItem("lang", document.getElementById("lang").value);
    applyLang();
}

/* -----------------------------
   NAVIGATION
------------------------------*/
function openPage(id){
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* -----------------------------
   UI Buttons
------------------------------*/
const moods = [
    {id:1, icon:"üòû", text:"–û—á–µ–Ω—å –ø–ª–æ—Ö–æ"},
    {id:2, icon:"üòï", text:"–ü–ª–æ—Ö–æ"},
    {id:3, icon:"üòê", text:"–ù–æ—Ä–º–∞–ª—å–Ω–æ"},
    {id:4, icon:"üôÇ", text:"–•–æ—Ä–æ—à–æ"},
    {id:5, icon:"üòÑ", text:"–û—Ç–ª–∏—á–Ω–æ"}
];

const factors = ["–°–æ–Ω","–°—Ç—Ä–µ—Å—Å","–†–∞–±–æ—Ç–∞","–û—Ç–¥—ã—Ö","–°–µ–º—å—è","–ï–¥–∞","–ó–¥–æ—Ä–æ–≤—å–µ","–ü–æ–≥–æ–¥–∞"];

moods.forEach(m=>{
    let div=document.createElement("div");
    div.className="mood-btn";
    div.innerHTML=m.icon+" "+m.text;
    div.onclick=()=>{
        currentMood=m.id;
        document.querySelectorAll(".mood-btn").forEach(x=>x.classList.remove("selected"));
        div.classList.add("selected");
    };
    document.getElementById("moodButtons").appendChild(div);
});

factors.forEach(f=>{
    let div=document.createElement("div");
    div.innerHTML=`<label><input type="checkbox" value="${f}"> ${f}</label>`;
    document.getElementById("factorList").appendChild(div);
});

/* -----------------------------
   SAVE ENTRY
------------------------------*/
function saveEntry(){
    if(!currentMood){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ"); return; }

    let fs=[...document.querySelectorAll("input[type=checkbox]:checked")].map(x=>x.value);

    const entry = {
        id:Date.now(),
        date:new Date().toISOString(),
        mood:currentMood,
        factors:fs,
        notes:document.getElementById("notes").value
    };

    DB.push(entry);
    localStorage.setItem("moodflow", JSON.stringify(DB));
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
}

/* -----------------------------
   HISTORY
------------------------------*/
function renderHistory(){
    let root=document.getElementById("historyList");
    root.innerHTML="";

    DB.slice().reverse().forEach(e=>{
        let div=document.createElement("div");
        div.className="history-item";
        div.innerHTML=`
            <b>${new Date(e.date).toLocaleString()}</b><br>
            –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${moods.find(x=>x.id===e.mood).text}<br>
            –§–∞–∫—Ç–æ—Ä—ã: ${e.factors.join(", ") || "‚Äî"}<br>${e.notes}
        `;
        root.appendChild(div);
    });
}
renderHistory();

/* -----------------------------
   EXPORT CSV
------------------------------*/
function exportCSV(){
    let csv="date,mood,factors,notes\n";
    DB.forEach(e=>{
        csv+=`"${e.date}", "${e.mood}", "${e.factors.join("|")}", "${e.notes}"\n`;
    });
    download(csv,"moodflow.csv","text/csv");
}

/* -----------------------------
   EXPORT XLSX
------------------------------*/
function exportXLSX(){
    let xml=`<?xml version="1.0"?>
        <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet">
        <Worksheet ss:Name="MoodFlow"><Table>
        <Row>
        <Cell><Data ss:Type="String">date</Data></Cell>
        <Cell><Data ss:Type="Number">mood</Data></Cell>
        <Cell><Data ss:Type="String">factors</Data></Cell>
        <Cell><Data ss:Type="String">notes</Data></Cell>
        </Row>`;

    DB.forEach(e=>{
        xml+=`<Row>
        <Cell><Data ss:Type="String">${e.date}</Data></Cell>
        <Cell><Data ss:Type="Number">${e.mood}</Data></Cell>
        <Cell><Data ss:Type="String">${e.factors.join("|")}</Data></Cell>
        <Cell><Data ss:Type="String">${e.notes}</Data></Cell>
        </Row>`;
    });

    xml+="</Table></Worksheet></Workbook>";
    download(xml,"moodflow.xls","application/vnd.ms-excel");
}

function download(content,filename,type){
    let blob=new Blob([content],{type});
    let url=URL.createObjectURL(blob);
    let a=document.createElement("a");
    a.href=url; a.download=filename; a.click();
    URL.revokeObjectURL(url);
}

/* -----------------------------
   PWA REGISTRATION
------------------------------*/
if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
