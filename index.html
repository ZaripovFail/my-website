<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoodFlow ‚Äî Pro (Enhanced)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#8D6E63; --primary-600:#7a5a4f; --bg:#F9ECCC; --surface:#fff; --text:#5D4037; --muted:#8D6E63;
      --border:#E0D1B4; --success:#5D8D63; --shadow:0 8px 30px rgba(0,0,0,.08); --glass:rgba(255,255,255,.6);
      --radius:12px; --transition:all .28s ease;
    }
    body.dark{ --primary:#caa78e; --bg:#0f1113; --surface:#141517; --text:#f1efee; --muted:#caa78e; --border:rgba(255,255,255,.06); --glass:rgba(255,255,255,.03); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: Inter, "Segoe UI", Roboto, Arial; margin:0; background:linear-gradient(180deg,var(--bg),#fff); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; line-height:1.25;
    }

    /* Header */
    .header{position:fixed;top:0;left:0;right:0;height:68px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg,var(--primary),var(--primary-600)); color:white; z-index:100; box-shadow:0 6px 20px rgba(0,0,0,.12);}
    .menu-toggle{position:absolute;left:16px;display:flex;align-items:center;gap:10px;cursor:pointer;font-size:18px}
    .header-title{font-weight:800;letter-spacing:-0.3px}
    .header-actions{position:absolute;right:12px;display:flex;align-items:center;gap:10px}
    .header-icon{cursor:pointer;opacity:.95;font-size:18px}

    /* Side menu */
    .side-menu{position:fixed;left:-320px;top:0;width:320px;height:100vh;background:var(--surface);padding-top:86px;
      box-shadow:2px 0 20px rgba(0,0,0,.06);transition:var(--transition);z-index:200;border-right:1px solid var(--border);backdrop-filter: blur(6px)}
    .side-menu.open{left:0}
    .menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;visibility:hidden;transition:var(--transition);z-index:180}
    .menu-overlay.show{opacity:1;visibility:visible}
    .menu-header{padding:16px 22px;font-weight:800;color:var(--primary)}
    .menu-item{padding:14px 22px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);cursor:pointer;font-weight:700;color:var(--text)}
    .menu-item.active{background:linear-gradient(90deg, rgba(141,110,99,0.06), transparent);color:var(--primary)}

    /* App container */
    .app{max-width:980px;margin:88px auto 48px;padding:18px}
    .card{background:var(--surface);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .section-title{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:12px}

    /* Mood row */
    .mood-row{display:flex;gap:10px}
    .mood-btn{flex:1;padding:14px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,var(--surface),var(--glass));
      display:flex;flex-direction:column;align-items:center;gap:8px;font-weight:800;font-size:14px;cursor:pointer;transition:var(--transition)}
    .mood-btn .emoji{font-size:28px}
    .mood-btn.active{transform:translateY(-8px);box-shadow:0 18px 40px rgba(0,0,0,.12);background:linear-gradient(180deg,var(--primary),var(--primary-600));color:white;border-color:transparent}

    /* Factors */
    .factors{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .factor-btn{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface);display:flex;align-items:center;gap:8px;justify-content:center;cursor:pointer;font-weight:700}
    .factor-btn.active{background:linear-gradient(90deg,var(--primary-light),var(--primary));color:white;box-shadow:0 8px 18px rgba(0,0,0,.06)}

    textarea{width:100%;min-height:110px;padding:12px;border-radius:10px;border:1px solid var(--border);resize:vertical;font-size:15px;background:var(--surface)}

    .save-btn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--primary);color:white;font-weight:800;cursor:pointer;margin-top:12px;display:flex;align-items:center;justify-content:center;gap:8px}
    .save-btn[disabled]{opacity:.45;cursor:not-allowed;background:var(--border)}

    /* Calendar */
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
    .weekday{font-weight:800;text-align:center;color:var(--muted);font-size:13px}
    .day{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg);cursor:pointer;border:1px dashed transparent;position:relative;user-select:none}
    .day.other-month{opacity:0.28}
    .day.has-entry::after{content:"";position:absolute;bottom:8px;height:8px;width:8px;border-radius:50%;background:var(--primary-light)}
    .day.active{background:var(--primary);color:white;box-shadow:0 12px 30px rgba(0,0,0,.12)}

    /* Stats & charts */
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}

    /* History */
    .history-list{display:flex;flex-direction:column;gap:12px;margin-top:8px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:400}
    .modal-backdrop.show{display:flex}
    .modal{width:96%;max-width:720px;background:var(--surface);border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .modal .modal-body{max-height:60vh;overflow:auto}

    /* Tools row */
    .tools{display:flex;gap:8px;align-items:center}

    /* Responsive */
    @media (max-width:720px){
      .app{margin:78px 12px 24px}
      .side-menu{width:80%;left:-100%}
      .mood-row{gap:8px}
    }
    @media (max-width:420px){
      .mood-row{flex-direction:column}
      .factors{grid-template-columns:1fr}
    }

    /* small helpers */
    .muted{color:var(--muted);font-weight:700}
    .tiny{font-size:13px;color:var(--muted)}
    .flex{display:flex;align-items:center;gap:8px}
    .pill{padding:6px 10px;border-radius:999px;background:var(--glass);font-weight:700}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="header" role="banner" aria-label="MoodFlow header">
    <div class="menu-toggle" id="menuToggle" aria-controls="sideMenu" aria-expanded="false">
      <i class="fas fa-bars"></i>
    </div>
    <div class="header-title" id="appTitle">MoodFlow</div>
    <div class="header-actions">
      <div class="tools" title="–Ø–∑—ã–∫" id="langWrap">
        <select id="langSelect" style="border-radius:8px;padding:6px;border:none;font-weight:700">
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
        </select>
      </div>
      <i title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" class="header-icon fas fa-chart-line" id="analyticsBtn"></i>
      <i title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" class="header-icon fas fa-cog" id="settingsBtn"></i>
    </div>
  </div>

  <nav id="sideMenu" class="side-menu" aria-hidden="true">
    <div class="menu-header">MoodFlow</div>
    <div class="menu-item active" data-tab="tracker"><i class="fas fa-plus-circle"></i> <span data-i18n="newEntry">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</span></div>
    <div class="menu-item" data-tab="calendar"><i class="fas fa-calendar-alt"></i> <span data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></div>
    <div class="menu-item" data-tab="analytics"><i class="fas fa-chart-bar"></i> <span data-i18n="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span></div>
    <div class="menu-item" data-tab="history"><i class="fas fa-history"></i> <span data-i18n="history">–ò—Å—Ç–æ—Ä–∏—è</span></div>
    <div class="menu-item" data-tab="insights"><i class="fas fa-lightbulb"></i> <span data-i18n="insights">–ò–Ω—Å–∞–π—Ç—ã</span></div>
    <div class="menu-item" data-tab="settings"><i class="fas fa-sliders-h"></i> <span data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    <div style="padding:14px 22px;border-top:1px solid var(--border);margin-top:8px">
      <button id="exportBtn" class="save-btn" style="width:100%;background:var(--text);"><i class="fas fa-download"></i> <span data-i18n="downloadBackup">–°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø (JSON)</span></button>
    </div>
  </nav>
  <div class="menu-overlay" id="menuOverlay" tabindex="-1"></div>

  <main class="app" id="app">
    <!-- Tracker -->
    <section id="tracker" class="card" role="region" aria-labelledby="trackerTitle">
      <h2 id="trackerTitle" class="section-title"><i class="fas fa-heart"></i> <span data-i18n="todayMood">–í–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è</span></h2>

      <div class="mood-row" id="moodRow" aria-label="–í—ã–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è">
        <button class="mood-btn" data-mood="1" aria-pressed="false"><div class="emoji">üò¢</div><div class="tiny" data-i18n="awful">–£–∂–∞—Å–Ω–æ</div></button>
        <button class="mood-btn" data-mood="2" aria-pressed="false"><div class="emoji">üòû</div><div class="tiny" data-i18n="bad">–ü–ª–æ—Ö–æ</div></button>
        <button class="mood-btn" data-mood="3" aria-pressed="false"><div class="emoji">üòê</div><div class="tiny" data-i18n="ok">–ù–æ—Ä–º–∞–ª—å–Ω–æ</div></button>
        <button class="mood-btn" data-mood="4" aria-pressed="false"><div class="emoji">üòä</div><div class="tiny" data-i18n="good">–•–æ—Ä–æ—à–æ</div></button>
        <button class="mood-btn" data-mood="5" aria-pressed="false"><div class="emoji">üòÑ</div><div class="tiny" data-i18n="great">–û—Ç–ª–∏—á–Ω–æ</div></button>
      </div>

      <div style="height:14px"></div>
      <h3 class="section-title"><i class="fas fa-sliders-h"></i> <span data-i18n="factors">–§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è–Ω–∏—è</span></h3>
      <div class="factors" id="factors" aria-label="–§–∞–∫—Ç–æ—Ä—ã">
        <button class="factor-btn" data-factor="sleep"><i class="fas fa-bed"></i> <span data-i18n="sleep">–°–æ–Ω</span></button>
        <button class="factor-btn" data-factor="work"><i class="fas fa-briefcase"></i> <span data-i18n="work">–†–∞–±–æ—Ç–∞</span></button>
        <button class="factor-btn" data-factor="social"><i class="fas fa-users"></i> <span data-i18n="social">–û–±—â–µ–Ω–∏–µ</span></button>
        <button class="factor-btn" data-factor="health"><i class="fas fa-heartbeat"></i> <span data-i18n="health">–ó–¥–æ—Ä–æ–≤—å–µ</span></button>
        <button class="factor-btn" data-factor="hobby"><i class="fas fa-palette"></i> <span data-i18n="hobby">–•–æ–±–±–∏</span></button>
        <button class="factor-btn" data-factor="family"><i class="fas fa-home"></i> <span data-i18n="family">–°–µ–º—å—è</span></button>
        <button class="factor-btn" data-factor="weather"><i class="fas fa-cloud-sun"></i> <span data-i18n="weather">–ü–æ–≥–æ–¥–∞</span></button>
        <button class="factor-btn" data-factor="finance"><i class="fas fa-money-bill-wave"></i> <span data-i18n="finance">–§–∏–Ω–∞–Ω—Å—ã</span></button>
      </div>

      <div style="height:14px"></div>
      <h3 class="section-title"><i class="fas fa-edit"></i> <span data-i18n="journal">–î–Ω–µ–≤–Ω–∏–∫ –¥–Ω—è</span></h3>
      <textarea id="notes" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è, –∫–∞–∫–∏–µ –º—ã—Å–ª–∏ –∏ —ç–º–æ—Ü–∏–∏ –≤—ã –∏—Å–ø—ã—Ç—ã–≤–∞–ª–∏..."></textarea>

      <button id="saveBtn" class="save-btn" disabled><i class="fas fa-save"></i> <span data-i18n="saveMood">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span></button>
    </section>

    <!-- Calendar -->
    <section id="calendar" class="card" role="region" aria-labelledby="calendarTitle" style="display:none;margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="calendarTitle" class="section-title"><i class="fas fa-calendar-alt"></i> <span data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</span></h2>
        <div class="flex">
          <button id="prevMonth" class="save-btn" style="padding:8px 12px;width:auto;background:var(--border);color:var(--text)"><i class="fas fa-chevron-left"></i></button>
          <div id="monthLabel" class="muted" style="min-width:160px;text-align:center"></div>
          <button id="nextMonth" class="save-btn" style="padding:8px 12px;width:auto;background:var(--border);color:var(--text)"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="calendar-grid" id="weekdayLabels" style="margin-top:12px"></div>
      <div class="calendar-grid" id="calendarGrid" style="margin-top:12px"></div>
    </section>

    <!-- Analytics -->
    <section id="analytics" class="card" role="region" aria-labelledby="analyticsTitle" style="display:none;margin-top:16px">
      <h2 id="analyticsTitle" class="section-title"><i class="fas fa-chart-line"></i> <span data-i18n="analytics">–î–∏–Ω–∞–º–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</span></h2>
      <div style="display:flex;gap:12px;flex-direction:column">
        <canvas id="moodChart" style="max-height:240px"></canvas>
        <div style="height:10px"></div>
        <canvas id="factorsChart" style="max-height:180px"></canvas>
      </div>
      <div style="height:12px"></div>
      <div class="stats-grid">
        <div class="card"><div class="muted" data-i18n="avgMood">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div><div style="font-size:20px;font-weight:800" id="avgMood">‚Äî</div></div>
        <div class="card"><div class="muted" data-i18n="totalEntries">–ó–∞–ø–∏—Å–µ–π –≤—Å–µ–≥–æ</div><div style="font-size:20px;font-weight:800" id="totalEntries">0</div></div>
      </div>
    </section>

    <!-- History -->
    <section id="history" class="card" role="region" aria-labelledby="historyTitle" style="display:none;margin-top:16px">
      <h2 id="historyTitle" class="section-title"><i class="fas fa-history"></i> <span data-i18n="history">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</span></h2>
      <div id="historyList" class="history-list"></div>
    </section>

    <!-- Insights -->
    <section id="insights" class="card" role="region" aria-labelledby="insightsTitle" style="display:none;margin-top:16px">
      <h2 id="insightsTitle" class="section-title"><i class="fas fa-lightbulb"></i> <span data-i18n="insights">–ò–Ω—Å–∞–π—Ç—ã</span></h2>
      <div id="insightsContent" class="muted tiny">–ò–Ω—Å–∞–π—Ç—ã –±—É–¥—É—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∑–∞–ø–∏—Å–µ–π.</div>
    </section>

    <!-- Settings -->
    <section id="settings" class="card" role="region" aria-labelledby="settingsTitle" style="display:none;margin-top:16px">
      <h2 id="settingsTitle" class="section-title"><i class="fas fa-cog"></i> <span data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1" class="card">
          <div class="tiny" data-i18n="darkTheme">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
          <div style="height:8px"></div>
          <label style="display:flex;align-items:center;gap:12px">
            <input id="darkToggle" type="checkbox" /> <span data-i18n="enable">–í–∫–ª—é—á–∏—Ç—å</span>
          </label>
        </div>
        <div style="flex:1" class="card">
          <div class="tiny" data-i18n="sync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
          <div style="height:8px"></div>
          <div class="tiny" data-i18n="exportImport">–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
          <div style="height:8px"></div>
          <div style="display:flex;gap:8px">
            <button id="exportBtn2" class="save-btn" style="background:var(--text)"><i class="fas fa-download"></i> <span data-i18n="download">–°–∫–∞—á–∞—Ç—å JSON</span></button>
            <label for="importFile" class="save-btn" style="background:var(--border);cursor:pointer"><i class="fas fa-upload"></i> <span data-i18n="import">–ò–º–ø–æ—Ä—Ç</span></label>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal backdrop -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-label="Modal">
      <div class="modal-header">
        <div id="modalTitle" style="font-weight:800"></div>
        <div><button id="modalClose" class="save-btn" style="padding:8px 10px;background:var(--border);color:var(--text)"><i class="fas fa-times"></i></button></div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  /* ------------------------------------------------------------
     MoodFlow ‚Äî Pro Enhanced
     –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ alert,
     –≥—Ä–∞—Ñ–∏–∫–∏ (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ + –≤–ª–∏—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–æ–≤), –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç,
     —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞, i18n (RU/EN/ES), —É–ª—É—á—à–µ–Ω–Ω—ã–π UX –∏ accessibility.
     ------------------------------------------------------------ */

  // ---------- i18n —Å–ª–æ–≤–∞—Ä—å (RU/EN/ES) -------------
  const i18n = {
    ru: {
      appTitle: "MoodFlow",
      newEntry: "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å",
      calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å",
      analytics: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
      history: "–ò—Å—Ç–æ—Ä–∏—è",
      insights: "–ò–Ω—Å–∞–π—Ç—ã",
      settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      todayMood: "–í–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è",
      awful: "–£–∂–∞—Å–Ω–æ", bad: "–ü–ª–æ—Ö–æ", ok: "–ù–æ—Ä–º–∞–ª—å–Ω–æ", good: "–•–æ—Ä–æ—à–æ", great: "–û—Ç–ª–∏—á–Ω–æ",
      factors: "–§–∞–∫—Ç–æ—Ä—ã –≤–ª–∏—è–Ω–∏—è",
      sleep: "–°–æ–Ω", work: "–†–∞–±–æ—Ç–∞", social: "–û–±—â–µ–Ω–∏–µ", health: "–ó–¥–æ—Ä–æ–≤—å–µ", hobby: "–•–æ–±–±–∏", family: "–°–µ–º—å—è", weather: "–ü–æ–≥–æ–¥–∞", finance: "–§–∏–Ω–∞–Ω—Å—ã",
      journal: "–î–Ω–µ–≤–Ω–∏–∫ –¥–Ω—è", saveMood: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ",
      downloadBackup: "–°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø (JSON)", download: "–°–∫–∞—á–∞—Ç—å JSON", import: "–ò–º–ø–æ—Ä—Ç",
      avgMood: "–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", totalEntries: "–ó–∞–ø–∏—Å–µ–π –≤—Å–µ–≥–æ",
      darkTheme: "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞", enable: "–í–∫–ª—é—á–∏—Ç—å",
      noEntries: "–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç",
      imported: "–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω",
      invalidFormat: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞",
      entriesDay: "–ó–∞–ø–∏—Å–∏ –∑–∞ –¥–µ–Ω—å",
      close: "–ó–∞–∫—Ä—ã—Ç—å",
      insightsNotEnough: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Å–∞–π—Ç–æ–≤",
    },
    en: {
      appTitle: "MoodFlow",
      newEntry: "New entry",
      calendar: "Calendar",
      analytics: "Analytics",
      history: "History",
      insights: "Insights",
      settings: "Settings",
      todayMood: "Your mood today",
      awful: "Awful", bad: "Bad", ok: "Okay", good: "Good", great: "Great",
      factors: "Influencing factors",
      sleep: "Sleep", work: "Work", social: "Social", health: "Health", hobby: "Hobby", family: "Family", weather: "Weather", finance: "Finance",
      journal: "Daily journal", saveMood: "Save mood",
      downloadBackup: "Download backup (JSON)", download: "Download JSON", import: "Import",
      avgMood: "Average mood", totalEntries: "Total entries",
      darkTheme: "Dark theme", enable: "Enable",
      noEntries: "No entries yet",
      imported: "Import finished",
      invalidFormat: "Invalid import file",
      entriesDay: "Entries for the day",
      close: "Close",
      insightsNotEnough: "Not enough data for insights",
    },
    es: {
      appTitle: "MoodFlow",
      newEntry: "Nueva entrada",
      calendar: "Calendario",
      analytics: "Anal√≠tica",
      history: "Historial",
      insights: "Ideas",
      settings: "Ajustes",
      todayMood: "Tu estado de √°nimo hoy",
      awful: "Terrible", bad: "Mal", ok: "Regular", good: "Bien", great: "Genial",
      factors: "Factores influyentes",
      sleep: "Sue√±o", work: "Trabajo", social: "Social", health: "Salud", hobby: "Hobby", family: "Familia", weather: "Clima", finance: "Finanzas",
      journal: "Diario", saveMood: "Guardar estado",
      downloadBackup: "Descargar respaldo (JSON)", download: "Descargar JSON", import: "Importar",
      avgMood: "Estado medio", totalEntries: "Total de entradas",
      darkTheme: "Tema oscuro", enable: "Activar",
      noEntries: "A√∫n no hay entradas",
      imported: "Importaci√≥n completada",
      invalidFormat: "Formato de archivo inv√°lido",
      entriesDay: "Entradas del d√≠a",
      close: "Cerrar",
      insightsNotEnough: "No hay suficientes datos para generar ideas",
    }
  };

  // ---------- State ----------
  let entries = JSON.parse(localStorage.getItem('moodEntries') || '[]');
  let currentMood = null;
  let selectedFactors = new Set();
  let currentYear = (new Date()).getFullYear();
  let currentMonth = (new Date()).getMonth();
  let currentLang = localStorage.getItem('mood_lang') || (navigator.language && navigator.language.startsWith('es') ? 'es' : (navigator.language && navigator.language.startsWith('en') ? 'en' : 'ru'));

  // ---------- Elements ----------
  const menuToggle = document.getElementById('menuToggle');
  const sideMenu = document.getElementById('sideMenu');
  const menuOverlay = document.getElementById('menuOverlay');
  const menuItems = Array.from(document.querySelectorAll('.menu-item'));
  const saveBtn = document.getElementById('saveBtn');
  const moodBtns = Array.from(document.querySelectorAll('.mood-btn'));
  const factorBtns = Array.from(document.querySelectorAll('.factor-btn'));
  const notesEl = document.getElementById('notes');
  const historyListEl = document.getElementById('historyList');
  const monthLabel = document.getElementById('monthLabel');
  const calendarGrid = document.getElementById('calendarGrid');
  const weekdayLabels = document.getElementById('weekdayLabels');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  const darkToggle = document.getElementById('darkToggle');
  const exportBtn = document.getElementById('exportBtn');
  const exportBtn2 = document.getElementById('exportBtn2');
  const importFile = document.getElementById('importFile');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalClose = document.getElementById('modalClose');
  const langSelect = document.getElementById('langSelect');
  const appTitle = document.getElementById('appTitle');

  // Chart contexts
  const moodCtx = document.getElementById('moodChart').getContext('2d');
  const factorsCtx = document.getElementById('factorsChart').getContext('2d');
  let moodChart = null, factorsChart = null;

  // ---------- Init ----------
  function init(){
    // language
    langSelect.value = currentLang;
    applyTranslations();

    // menu
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', closeMenu);
    menuItems.forEach(it => {
      it.addEventListener('click', () => {
        menuItems.forEach(m => m.classList.remove('active'));
        it.classList.add('active');
        switchTab(it.dataset.tab);
        closeMenu();
      });
    });
    document.getElementById('analyticsBtn').addEventListener('click', () => { activateMenuItem('analytics'); switchTab('analytics'); });
    document.getElementById('settingsBtn').addEventListener('click', () => { activateMenuItem('settings'); switchTab('settings'); });

    // mood buttons
    moodBtns.forEach(btn => btn.addEventListener('click', () => {
      moodBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
      currentMood = Number(btn.dataset.mood); updateSaveState();
    }));

    // factors
    factorBtns.forEach(btn => btn.addEventListener('click', () => {
      const f = btn.dataset.factor;
      if (selectedFactors.has(f)){ selectedFactors.delete(f); btn.classList.remove('active'); }
      else { selectedFactors.add(f); btn.classList.add('active'); }
    }));

    // save
    saveBtn.addEventListener('click', saveEntry);

    // calendar nav
    prevMonthBtn.addEventListener('click', ()=>changeMonth(-1));
    nextMonthBtn.addEventListener('click', ()=>changeMonth(1));

    // theme
    const darkPref = localStorage.getItem('mood_dark') === '1';
    darkToggle.checked = darkPref;
    document.body.classList.toggle('dark', darkPref);
    darkToggle.addEventListener('change', (e)=>{ document.body.classList.toggle('dark', e.target.checked); localStorage.setItem('mood_dark', e.target.checked ? '1':'0'); renderAnalytics(); });

    // export/import
    exportBtn.addEventListener('click', downloadBackup);
    exportBtn2.addEventListener('click', downloadBackup);
    importFile.addEventListener('change', handleImportFile);

    // modal
    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

    // language switch
    langSelect.addEventListener('change', ()=>{ currentLang = langSelect.value; localStorage.setItem('mood_lang', currentLang); applyTranslations(); });

    // keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'n'){ activateMenuItem('tracker'); switchTab('tracker'); }
      if (e.key.toLowerCase() === 'c'){ activateMenuItem('calendar'); switchTab('calendar'); }
      if (e.key.toLowerCase() === 'h'){ activateMenuItem('history'); switchTab('history'); }
    });

    // initial renders
    renderWeekdayLabels();
    renderCalendar(currentYear, currentMonth);
    renderHistory();
    renderAnalytics();
  }

  // ---------- UI helpers ----------
  function toggleMenu(){
    const open = sideMenu.classList.toggle('open');
    menuOverlay.classList.toggle('show', open);
    sideMenu.setAttribute('aria-hidden', String(!open));
    menuToggle.setAttribute('aria-expanded', String(open));
  }
  function closeMenu(){ sideMenu.classList.remove('open'); menuOverlay.classList.remove('show'); sideMenu.setAttribute('aria-hidden','true'); menuToggle.setAttribute('aria-expanded','false'); }
  function activateMenuItem(tab){ menuItems.forEach(m => m.classList.toggle('active', m.dataset.tab === tab)); }
  function switchTab(tabId){
    ['tracker','calendar','analytics','history','insights','settings'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = (id === tabId) ? 'block' : 'none';
    });
    if (tabId === 'calendar') renderCalendar(currentYear, currentMonth);
    if (tabId === 'analytics') renderAnalytics();
    if (tabId === 'history') renderHistory();
  }
  function updateSaveState(){ saveBtn.disabled = currentMood === null; }

  // ---------- Save / Import / Export ----------
  function saveEntry(){
    if (currentMood === null) return;
    const now = new Date();
    const entry = {
      id: now.getTime() + Math.floor(Math.random()*1000),
      mood: currentMood,
      factors: Array.from(selectedFactors),
      notes: notesEl.value.trim(),
      dateISO: now.toISOString()
    };
    entries.push(entry);
    localStorage.setItem('moodEntries', JSON.stringify(entries));

    // feedback
    const orig = saveBtn.innerHTML;
    saveBtn.innerHTML = `<i class="fas fa-check"></i> ${translate('saveSuccess') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'}`;
    saveBtn.style.background = 'var(--success)';
    setTimeout(()=>{ saveBtn.innerHTML = orig; saveBtn.style.background = ''; }, 1200);

    // reset
    currentMood = null; selectedFactors.clear();
    moodBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    factorBtns.forEach(b => b.classList.remove('active'));
    notesEl.value = '';
    updateSaveState();

    // update UI
    renderHistory();
    renderCalendar(currentYear, currentMonth);
    renderAnalytics();
  }

  function downloadBackup(){
    const blob = new Blob([JSON.stringify(entries, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `moodflow_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function handleImportFile(e){
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const data = JSON.parse(ev.target.result);
        if (!Array.isArray(data)) throw new Error('invalid');
        // merge by id (keep existing)
        const byId = new Map(entries.map(en => [en.id, en]));
        data.forEach(d => {
          if (!d.id) d.id = Date.now() + Math.floor(Math.random()*1000);
          byId.set(d.id, d);
        });
        entries = Array.from(byId.values()).sort((a,b)=>a.id - b.id);
        localStorage.setItem('moodEntries', JSON.stringify(entries));
        showModal(translate('imported') || '–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω', `<div>${translate('imported') || '–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω'}. ${entries.length} ${translate('totalEntries') || '–∑–∞–ø–∏—Å–µ–π'}.</div>`);
        renderHistory(); renderCalendar(currentYear, currentMonth); renderAnalytics();
      } catch(err){
        showModal(translate('invalidFormat') || '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç', `<div>${translate('invalidFormat') || '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'}</div>`);
      }
    };
    reader.readAsText(file);
    importFile.value = '';
  }

  // ---------- Calendar ----------
  function renderWeekdayLabels(){
    const names = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
    // support translation for weekday short names (keep Russian order for simplicity)
    weekdayLabels.innerHTML = names.map(n => `<div class="weekday">${n}</div>`).join('');
  }

  function renderCalendar(year, month){
    calendarGrid.innerHTML = '';
    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);
    const startWeekDay = (first.getDay() + 6) % 7; // Monday=0
    const daysInMonth = last.getDate();

    const prevLast = new Date(year, month, 0).getDate();
    const totalCells = 42;
    monthLabel.textContent = first.toLocaleString(currentLang === 'ru' ? 'ru-RU' : (currentLang === 'en' ? 'en-GB' : 'es-ES'), {month:'long', year:'numeric'});

    const cells = [];
    for (let i = 0; i < startWeekDay; i++) cells.push({day: prevLast - startWeekDay + i + 1, otherMonth: true, m: month-1});
    for (let d = 1; d <= daysInMonth; d++) cells.push({day: d, otherMonth: false, m: month});
    while (cells.length < totalCells) cells.push({day: cells.length - (startWeekDay + daysInMonth) + 1, otherMonth: true, m: month+1});

    // group entries by local date key
    const map = {};
    entries.forEach(e => {
      const dt = new Date(e.dateISO);
      const key = `${dt.getFullYear()}-${dt.getMonth()}-${dt.getDate()}`;
      if (!map[key]) map[key] = [];
      map[key].push(e);
    });

    for (let i = 0; i < cells.length; i++){
      const c = cells[i];
      const el = document.createElement('div');
      el.className = 'day' + (c.otherMonth ? ' other-month' : '');
      el.textContent = c.day;
      if (!c.otherMonth){
        const key = `${year}-${month}-${c.day}`;
        if (map[key] && map[key].length){
          el.classList.add('has-entry');
          el.title = `${map[key].length} ${translate('entries') || '–∑–∞–ø–∏—Å–µ–π'}`;
        }
        el.addEventListener('click', () => {
          const dt = new Date(year, month, c.day);
          showDayEntries(dt);
          calendarGrid.querySelectorAll('.day').forEach(d=>d.classList.remove('active'));
          el.classList.add('active');
        });
      } else {
        el.style.opacity = '0.6';
      }
      calendarGrid.appendChild(el);
    }
  }

  function showDayEntries(date){
    const dayEntries = entries.filter(e => {
      const dt = new Date(e.dateISO);
      return dt.getFullYear() === date.getFullYear() && dt.getMonth() === date.getMonth() && dt.getDate() === date.getDate();
    });
    if (dayEntries.length === 0){
      showModal(translate('noEntries') || '–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç', `<div>${translate('noEntries') || '–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç'}</div>`);
      return;
    }
    // build HTML list
    const lines = dayEntries.sort((a,b)=>b.id-a.id).map(e => {
      const d = new Date(e.dateISO).toLocaleTimeString(currentLang === 'ru' ? 'ru-RU' : (currentLang === 'en' ? 'en-GB' : 'es-ES'), {hour:'2-digit', minute:'2-digit'});
      const factors = e.factors && e.factors.length ? `<div style="margin-top:6px">${e.factors.map(f => `<span class="pill">${escapeHtml(translate(f) || f)}</span>`).join(' ')}</div>` : '';
      const note = e.notes ? `<div style="margin-top:8px;color:var(--muted);white-space:pre-wrap">${escapeHtml(e.notes)}</div>` : '';
      return `<div style="padding:10px;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">${getMoodEmoji(e.mood)} ${e.mood}/5</div><div class="tiny">${d}</div></div>${factors}${note}</div>`;
    }).join('');
    showModal(`${translate('entriesDay') || '–ó–∞–ø–∏—Å–∏ –∑–∞ –¥–µ–Ω—å'} ‚Äî ${date.toLocaleDateString()}`, `<div>${lines}</div>`);
  }

  function changeMonth(delta){
    currentMonth += delta;
    if (currentMonth < 0){ currentMonth = 11; currentYear -= 1; }
    if (currentMonth > 11){ currentMonth = 0; currentYear += 1; }
    renderCalendar(currentYear, currentMonth);
  }

  // ---------- History ----------
  function renderHistory(){
    const recent = entries.slice(-50).reverse();
    if (recent.length === 0){
      historyListEl.innerHTML = `<div style="padding:28px;text-align:center;color:var(--muted)">${translate('noEntries') || '–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç'}</div>`;
      return;
    }
    historyListEl.innerHTML = recent.map(e => {
      const d = new Date(e.dateISO);
      const dd = d.toLocaleString(currentLang === 'ru' ? 'ru-RU' : (currentLang === 'en' ? 'en-GB' : 'es-ES'), {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
      const factorsHtml = (e.factors && e.factors.length) ? `<div style="margin-top:6px">${e.factors.map(f => `<span class="pill">${escapeHtml(translate(f) || f)}</span>`).join(' ')}</div>` : '';
      const noteHtml = e.notes ? `<div style="margin-top:8px;color:var(--muted);font-size:14px;white-space:pre-wrap">${escapeHtml(e.notes)}</div>` : '';
      return `<div class="card"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800;font-size:18px">${getMoodEmoji(e.mood)} &nbsp; ${e.mood}/5</div><div class="tiny">${dd}</div></div>${factorsHtml}${noteHtml}</div>`;
    }).join('');
  }

  // ---------- Analytics ----------
  function renderAnalytics(){
    // 30-day mood chart
    const labels = [];
    const dataPoints = [];
    for (let i = 29; i >= 0; i--){
      const dt = new Date();
      dt.setDate(dt.getDate() - i);
      labels.push(dt.toLocaleDateString(currentLang === 'ru' ? 'ru-RU' : (currentLang === 'en' ? 'en-GB' : 'es-ES'), {day:'2-digit', month:'2-digit'}));
      const dayEntries = entries.filter(e => {
        const d = new Date(e.dateISO);
        return d.getFullYear() === dt.getFullYear() && d.getMonth() === dt.getMonth() && d.getDate() === dt.getDate();
      });
      if (dayEntries.length){
        const avg = dayEntries.reduce((s, it) => s + it.mood, 0)/dayEntries.length;
        dataPoints.push(Number(avg.toFixed(2)));
      } else dataPoints.push(null);
    }

    document.getElementById('totalEntries').textContent = entries.length;
    const allMoods = entries.map(e=>e.mood);
    const avg = allMoods.length ? (allMoods.reduce((s,a)=>s+a,0)/allMoods.length).toFixed(2) : '‚Äî';
    document.getElementById('avgMood').textContent = avg;

    // destroy previous charts
    if (moodChart) moodChart.destroy();
    if (factorsChart) factorsChart.destroy();

    moodChart = new Chart(moodCtx, {
      type: 'line',
      data: { labels, datasets: [{ label: translate('analytics') || '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ', data: dataPoints, spanGaps:true, tension:0.35, borderWidth:3, borderColor: getComputedStyle(document.body).classList.contains('dark') ? '#caa78e' : '#8D6E63', backgroundColor:'transparent', pointRadius:4 }] },
      options: { interaction:{mode:'index',intersect:false}, plugins:{legend:{display:false}}, scales:{ y:{min:1,max:5,ticks:{stepSize:1}}, x:{display:true}}, maintainAspectRatio:false }
    });

    // factors influence: compute average mood when factor present
    const factorList = Array.from(new Set(entries.flatMap(e => e.factors || [])));
    const allFactors = factorList.length ? factorList : ['sleep','work','social','health','hobby','family','weather','finance'];
    const factorLabels = allFactors.map(f => translate(f) || f);
    const factorValues = allFactors.map(f => {
      const withF = entries.filter(e => e.factors && e.factors.includes(f));
      return withF.length ? Number((withF.reduce((s,it)=>s+it.mood,0)/withF.length).toFixed(2)) : null;
    });

    factorsChart = new Chart(factorsCtx, {
      type: 'bar',
      data: { labels: factorLabels, datasets:[{ label: translate('factors') || '–§–∞–∫—Ç–æ—Ä—ã', data: factorValues, backgroundColor:factorValues.map(v => v ? (getComputedStyle(document.body).classList.contains('dark') ? 'rgba(202,167,142,0.9)' : 'rgba(141,110,99,0.86)') : 'rgba(200,200,200,0.18)') }] },
      options: { plugins:{legend:{display:false}}, scales:{ y:{min:1,max:5,ticks:{stepSize:1}} }, maintainAspectRatio:false }
    });
  }

  // ---------- Insights (simple) ----------
  function computeInsights(){
    if (entries.length < 5) return translate('insightsNotEnough') || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Å–∞–π—Ç–æ–≤';
    // find worst/best factors
    const factorMap = {};
    entries.forEach(e => {
      (e.factors || []).forEach(f => {
        if (!factorMap[f]) factorMap[f] = {sum:0,count:0};
        factorMap[f].sum += e.mood; factorMap[f].count += 1;
      });
    });
    const arr = Object.entries(factorMap).map(([k,v]) => ({factor:k, avg: v.sum/v.count, count:v.count}));
    arr.sort((a,b)=>a.avg - b.avg);
    if (!arr.length) return translate('insightsNotEnough') || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Å–∞–π—Ç–æ–≤';
    const worst = arr.slice(0,2).map(a=>`${translate(a.factor)||a.factor} (${a.avg.toFixed(2)})`).join(', ');
    const best = arr.slice(-2).reverse().map(a=>`${translate(a.factor)||a.factor} (${a.avg.toFixed(2)})`).join(', ');
    return `<div><strong>${translate('insights') || '–ò–Ω—Å–∞–π—Ç—ã'}:</strong></div><div style="margin-top:8px"> - –ù–µ–≥–∞—Ç–∏–≤–Ω–µ–µ –≤—Å–µ–≥–æ –≤–ª–∏—è—é—Ç: ${worst}</div><div style="margin-top:8px"> - –ü–æ–∑–∏—Ç–∏–≤–Ω–µ–µ –≤—Å–µ–≥–æ –≤–ª–∏—è—é—Ç: ${best}</div>`;
  }

  // ---------- Modal ----------
  function showModal(title, html){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    modalBackdrop.classList.add('show');
    modalBackdrop.setAttribute('aria-hidden','false');
  }
  function closeModal(){ modalBackdrop.classList.remove('show'); modalBackdrop.setAttribute('aria-hidden','true'); }

  // ---------- Utils ----------
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function getMoodEmoji(mood){ return ['üò¢','üòû','üòê','üòä','üòÑ'][mood-1] || 'üòê'; }

  // translation helper
  function translate(key){
    const dict = i18n[currentLang] || i18n['ru'];
    return dict[key] || dict[key.toLowerCase()] || null;
  }

  // apply translations to page
  function applyTranslations(){
    // replace all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const txt = translate(key);
      if (txt) el.textContent = txt;
    });
    // title and header
    const t = translate('appTitle') || 'MoodFlow';
    document.title = t + ' ‚Äî Pro';
    appTitle.textContent = t;
    // render again for language-sensitive elements
    renderWeekdayLabels();
    renderCalendar(currentYear, currentMonth);
    renderHistory();
    renderAnalytics();
  }

  // ---------- Initial run ----------
  init();

  </script>
</body>
</html>
